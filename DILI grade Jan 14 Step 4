library(tidyverse)
library(readxl)
library(dplyr)
library(lubridate)
library(doBy)
library(plyr)
library(readr)     
library(frequency)   
library(DescTools)
library(purrr)
Sys.setenv(JAVA_HOME='C:\\Program Files\\Java\\jre1.8.0_261\\jre')
library(rJava)
library(xlsx)
library(lubridate)
library(dostats)


setwd("E:/Ningbo Projects/TB/TB project/Workingd/CSV files/")

IPT<-read_csv("IPT.csv")
OPT<-read_csv("OPT.csv")

id_list<-read_csv("id_list_0113_final.csv")
id_list_index<-id_list %>% select(idcard,  Dx_date, )

#Highest grade of DILI during TB treatment
#Extract relevant clinical variables from the IPT and OPT diagnosis
Case_OPT<-filter(OPT, grepl("腹水",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time

Case_IPT<-filter(IPT, grepl("腹水",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time

Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)

Case_all<-rbind(Case_OPT,Case_IPT)

Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_all_index$diff_in_days = as.numeric(difftime(Case_all_index$Case_time, Case_all_index$Dx_date, units = "days")) 

Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
Case_post_index<-Case_all_index [Case_all_index$Case_time>=Case_all_index$Dx_date,]

summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_post<-Case_post_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)

colnames(summary_Case_pre)[colnames(summary_Case_pre) %in% c("Case_time")] <- c("Ascites_pre_dx_date")
colnames(summary_Case_post)[colnames(summary_Case_post) %in% c("Case_time")] <- c("Ascites_post_dx_date")

id_list1 <- left_join(id_list,  summary_Case_pre,  by = "idcard") 
id_list2 <- left_join(id_list1, summary_Case_post, by = "idcard") 
#肝性脑病
Case_OPT<-filter(OPT, grepl("肝性脑病",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time

Case_IPT<-filter(IPT, grepl("肝性脑病",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time

Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)

Case_all<-rbind(Case_OPT,Case_IPT)

Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_all_index$diff_in_days = as.numeric(difftime(Case_all_index$Case_time, Case_all_index$Dx_date, units = "days")) 

Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
Case_post_index<-Case_all_index [Case_all_index$Case_time>=Case_all_index$Dx_date,]

summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_post<-Case_post_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)

colnames(summary_Case_pre)[colnames(summary_Case_pre) %in% c("Case_time")] <- c("Hepaence_pre_dx_date")
colnames(summary_Case_post)[colnames(summary_Case_post) %in% c("Case_time")] <- c("Hepaence_post_dx_date")

id_list3 <- left_join(id_list2,  summary_Case_pre,  by = "idcard") 
id_list4 <- left_join(id_list3, summary_Case_post, by = "idcard")  

#肝硬化
Case_OPT<-filter(OPT, grepl("肝硬化",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time

Case_IPT<-filter(IPT, grepl("肝硬化",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time

Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)

Case_all<-rbind(Case_OPT,Case_IPT)

Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_all_index$diff_in_days = as.numeric(difftime(Case_all_index$Case_time, Case_all_index$Dx_date, units = "days")) 

Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
Case_post_index<-Case_all_index [Case_all_index$Case_time>=Case_all_index$Dx_date,]

summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_post<-Case_post_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)

colnames(summary_Case_pre)[colnames(summary_Case_pre) %in% c("Case_time")] <- c("Cirrhosis_pre_dx_date")
colnames(summary_Case_post)[colnames(summary_Case_post) %in% c("Case_time")] <- c("Cirrhosis_post_dx_date")

id_list5 <- left_join(id_list4,  summary_Case_pre,  by = "idcard") 
id_list6 <- left_join(id_list5, summary_Case_post, by = "idcard") 

#脂肪肝
Case_OPT<-filter(OPT, grepl("脂肪肝",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time

Case_IPT<-filter(IPT, grepl("脂肪肝",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time

Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)

Case_all<-rbind(Case_OPT,Case_IPT)

Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_all_index$diff_in_days = as.numeric(difftime(Case_all_index$Case_time, Case_all_index$Dx_date, units = "days")) 

Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
Case_post_index<-Case_all_index [Case_all_index$Case_time>=Case_all_index$Dx_date,]

summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_post<-Case_post_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)

colnames(summary_Case_pre)[colnames(summary_Case_pre) %in% c("Case_time")] <- c("Fattyliver_pre_dx_date")
colnames(summary_Case_post)[colnames(summary_Case_post) %in% c("Case_time")] <- c("Fattyliver_post_dx_date")

id_list7 <- left_join(id_list6,  summary_Case_pre,  by = "idcard") 
id_list8 <- left_join(id_list7, summary_Case_post, by = "idcard") 



#乙型肝炎

Case_OPT<-filter(OPT,  grepl("乙型肝炎",disease_name)|grepl("乙肝",disease_name) | grepl("乙型病毒性肝炎",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time

Case_IPT<-filter(IPT,  grepl("乙型肝炎",disease_name)|grepl("乙肝",disease_name) | grepl("乙型病毒性肝炎",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time

Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)

Case_all<-rbind(Case_OPT,Case_IPT)

Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_all_index$diff_in_days = as.numeric(difftime(Case_all_index$Case_time, Case_all_index$Dx_date, units = "days")) 

Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
Case_post_index<-Case_all_index [Case_all_index$Case_time>=Case_all_index$Dx_date,]

summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_post<-Case_post_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)

colnames(summary_Case_pre)[colnames(summary_Case_pre) %in% c("Case_time")] <- c("HBV_pre_dx_date")
colnames(summary_Case_post)[colnames(summary_Case_post) %in% c("Case_time")] <- c("HBV_post_dx_date")

id_list9 <- left_join(id_list8,  summary_Case_pre,  by = "idcard") 
id_list1 <- left_join(id_list9, summary_Case_post, by = "idcard") 

#丙型肝炎

Case_OPT<-filter(OPT,  grepl("丙型肝炎",disease_name)|grepl("丙肝",disease_name) | grepl("丙型病毒性肝炎",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time

Case_IPT<-filter(IPT,  grepl("丙型肝炎",disease_name)|grepl("丙肝",disease_name) | grepl("丙型病毒性肝炎",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time

Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)

Case_all<-rbind(Case_OPT,Case_IPT)

Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_all_index$diff_in_days = as.numeric(difftime(Case_all_index$Case_time, Case_all_index$Dx_date, units = "days")) 

Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
Case_post_index<-Case_all_index [Case_all_index$Case_time>=Case_all_index$Dx_date,]

summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_post<-Case_post_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)

colnames(summary_Case_pre)[colnames(summary_Case_pre) %in% c("Case_time")] <- c("HCV_pre_dx_date")
colnames(summary_Case_post)[colnames(summary_Case_post) %in% c("Case_time")] <- c("HCV_post_dx_date")

id_list2 <- left_join(id_list1,  summary_Case_pre,  by = "idcard") 
id_list3 <- left_join(id_list2, summary_Case_post, by = "idcard") 

#自身免疫性肝炎

Case_OPT<-filter(OPT,  grepl("自身免疫性肝炎",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time

Case_IPT<-filter(IPT,  grepl("自身免疫性肝炎",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time

Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)

Case_all<-rbind(Case_OPT,Case_IPT)

Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_all_index$diff_in_days = as.numeric(difftime(Case_all_index$Case_time, Case_all_index$Dx_date, units = "days")) 

Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
Case_post_index<-Case_all_index [Case_all_index$Case_time>=Case_all_index$Dx_date,]

summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_post<-Case_post_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)

colnames(summary_Case_pre)[colnames(summary_Case_pre) %in% c("Case_time")] <- c("AutoHepatitis_pre_dx_date")
colnames(summary_Case_post)[colnames(summary_Case_post) %in% c("Case_time")] <- c("AutoHepatitis_post_dx_date")

id_list4 <- left_join(id_list3,  summary_Case_pre,  by = "idcard") 
id_list5 <- left_join(id_list4, summary_Case_post, by = "idcard") 

#Baseline characteristics/CCI index

Case_OPT<-filter(OPT,  grepl("心肌缺血",disease_name)| grepl("心肌梗",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time
Case_IPT<-filter(IPT,  grepl("心肌缺血",disease_name)| grepl("心肌梗",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time
Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)
Case_all<-rbind(Case_OPT,Case_IPT)
Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_pre$CCI_MI<-1
summary_Case_pre<-summary_Case_pre %>% select(idcard,  CCI_MI, )
id_list6 <- left_join(id_list5, summary_Case_pre, by = "idcard") 

Case_OPT<-filter(OPT,  grepl("心衰",disease_name) | grepl("心力衰竭",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time
Case_IPT<-filter(IPT,  grepl("心衰",disease_name) | grepl("心力衰竭",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time
Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)
Case_all<-rbind(Case_OPT,Case_IPT)
Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_pre$CCI_CHF<-1
summary_Case_pre<-summary_Case_pre %>% select(idcard,  CCI_CHF, )
id_list7 <- left_join(id_list6, summary_Case_pre, by = "idcard") 

Case_OPT<-filter(OPT,  grepl("周围血管",disease_name) )
Case_OPT$Case_time<-Case_OPT$clinic_time
Case_IPT<-filter(IPT,  grepl("周围血管",disease_name) )
Case_IPT$Case_time<-Case_IPT$dis_time
Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)
Case_all<-rbind(Case_OPT,Case_IPT)
Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_pre$CCI_PVD<-1
summary_Case_pre<-summary_Case_pre %>% select(idcard,  CCI_PVD, )
id_list8 <- left_join(id_list7, summary_Case_pre, by = "idcard") 

Case_OPT<-filter(OPT,  grepl("脑血管",disease_name) | grepl("短暂性脑缺血发作",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time
Case_IPT<-filter(IPT,  grepl("脑血管",disease_name) | grepl("短暂性脑缺血发作",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time
Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)
Case_all<-rbind(Case_OPT,Case_IPT)
Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_pre$CCI_CVD<-1
summary_Case_pre<-summary_Case_pre %>% select(idcard,  CCI_CVD, )
id_list9 <- left_join(id_list8, summary_Case_pre, by = "idcard") 

Case_OPT<-filter(OPT,  grepl("偏瘫",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time
Case_IPT<-filter(IPT,  grepl("偏瘫",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time
Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)
Case_all<-rbind(Case_OPT,Case_IPT)
Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_pre$CCI_Hemiplegia<-2
summary_Case_pre<-summary_Case_pre %>% select(idcard,  CCI_Hemiplegia, )
id_list1 <- left_join(id_list9, summary_Case_pre, by = "idcard") 

Case_OPT<-filter(OPT,  grepl("痴呆",disease_name) | grepl("阿尔茨海默",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time
Case_IPT<-filter(IPT,  grepl("痴呆",disease_name) | grepl("阿尔茨海默",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time
Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)
Case_all<-rbind(Case_OPT,Case_IPT)
Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_pre$CCI_Dementia<-1
summary_Case_pre<-summary_Case_pre %>% select(idcard,  CCI_Dementia, )
id_list2 <- left_join(id_list1, summary_Case_pre, by = "idcard") 

Case_OPT<-filter(OPT,  grepl("慢性阻塞性肺",disease_name) | grepl("慢性支气管炎",disease_name) | grepl("哮喘",disease_name) | grepl("肺气肿",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time
Case_IPT<-filter(IPT,  grepl("慢性阻塞性肺",disease_name) | grepl("慢性支气管炎",disease_name) | grepl("哮喘",disease_name) | grepl("肺气肿",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time
Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)
Case_all<-rbind(Case_OPT,Case_IPT)
Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_pre$CCI_COPD<-1
summary_Case_pre<-summary_Case_pre %>% select(idcard,  CCI_COPD, )
id_list3 <- left_join(id_list2, summary_Case_pre, by = "idcard") 

Case_OPT<-filter(OPT,  grepl("类风湿",disease_name) | grepl("结缔组织疾病",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time
Case_IPT<-filter(IPT,  grepl("类风湿",disease_name) | grepl("结缔组织疾病",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time
Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)
Case_all<-rbind(Case_OPT,Case_IPT)
Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_pre$CCI_CTD<-1
summary_Case_pre<-summary_Case_pre %>% select(idcard,  CCI_CTD, )
id_list4 <- left_join(id_list3, summary_Case_pre, by = "idcard") 

Case_OPT<-filter(OPT,  grepl("溃疡",disease_name) & (grepl("消化性",disease_name) | grepl("胃",disease_name)| grepl("十二指肠",disease_name)| grepl("食道",disease_name)))
Case_OPT$Case_time<-Case_OPT$clinic_time
Case_IPT<-filter(IPT,  grepl("溃疡",disease_name) & (grepl("消化性",disease_name) | grepl("胃",disease_name)| grepl("十二指肠",disease_name)| grepl("食道",disease_name)))
Case_IPT$Case_time<-Case_IPT$dis_time
Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)
Case_all<-rbind(Case_OPT,Case_IPT)
Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_pre$CCI_PUD<-1
summary_Case_pre<-summary_Case_pre %>% select(idcard,  CCI_PUD, )
id_list5 <- left_join(id_list4, summary_Case_pre, by = "idcard") 

Case_OPT<-filter(OPT,  grepl("糖尿病",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time
Case_IPT<-filter(IPT,  grepl("糖尿病",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time
Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)
Case_all<-rbind(Case_OPT,Case_IPT)
Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_pre$CCI_Diabetes<-1
summary_Case_pre<-summary_Case_pre %>% select(idcard,  CCI_Diabetes, )
id_list6 <- left_join(id_list5, summary_Case_pre, by = "idcard") 

Case_OPT<-filter(OPT,  (grepl("糖尿病",disease_name) & grepl("肾",disease_name)) |
                   (grepl("糖尿病",disease_name) & grepl("血管",disease_name)) |
                   (grepl("糖尿病",disease_name) & grepl("神经",disease_name)) |
                   (grepl("糖尿病",disease_name) & grepl("视网膜",disease_name)) )
Case_OPT$Case_time<-Case_OPT$clinic_time
Case_IPT<-filter(IPT,  (grepl("糖尿病",disease_name) & grepl("肾",disease_name)) |
                   (grepl("糖尿病",disease_name) & grepl("血管",disease_name)) |
                   (grepl("糖尿病",disease_name) & grepl("神经",disease_name)) |
                   (grepl("糖尿病",disease_name) & grepl("视网膜",disease_name)) )
Case_IPT$Case_time<-Case_IPT$dis_time
Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)
Case_all<-rbind(Case_OPT,Case_IPT)
Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_pre$CCI_Diabetescomplic<-1
summary_Case_pre<-summary_Case_pre %>% select(idcard,  CCI_Diabetescomplic, )
id_list7 <- left_join(id_list6, summary_Case_pre, by = "idcard") 

Case_OPT<-filter(OPT,  grepl("慢性肾脏病",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time
Case_IPT<-filter(IPT,  grepl("慢性肾脏病",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time
Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)
Case_all<-rbind(Case_OPT,Case_IPT)
Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_pre$CCI_CKD<-2
summary_Case_pre<-summary_Case_pre %>% select(idcard,  CCI_CKD, )
id_list8 <- left_join(id_list7, summary_Case_pre, by = "idcard") 

Case_OPT<-filter(OPT,  grepl("肿瘤",disease_name) | grepl("癌",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time
Case_IPT<-filter(IPT,  grepl("肿瘤",disease_name) | grepl("癌",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time
Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)
Case_all<-rbind(Case_OPT,Case_IPT)
Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_pre$CCI_cancer<-2
summary_Case_pre<-summary_Case_pre %>% select(idcard,  CCI_cancer, )
id_list9 <- left_join(id_list8, summary_Case_pre, by = "idcard") 

Case_OPT<-filter(OPT,  (grepl("肿瘤",disease_name) | grepl("癌",disease_name)) & grepl("转移",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time
Case_IPT<-filter(IPT,  (grepl("肿瘤",disease_name) | grepl("癌",disease_name)) & grepl("转移",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time
Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)
Case_all<-rbind(Case_OPT,Case_IPT)
Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_pre$CCI_cancermeta<-6
summary_Case_pre<-summary_Case_pre %>% select(idcard,  CCI_cancermeta, )
id_list1 <- left_join(id_list9, summary_Case_pre, by = "idcard") 

Case_OPT<-filter(OPT,  grepl("白血病",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time
Case_IPT<-filter(IPT,  grepl("白血病",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time
Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)
Case_all<-rbind(Case_OPT,Case_IPT)
Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_pre$CCI_leukemia<-2
summary_Case_pre<-summary_Case_pre %>% select(idcard,  CCI_leukemia, )
id_list2 <- left_join(id_list1, summary_Case_pre, by = "idcard") 

Case_OPT<-filter(OPT,  grepl("淋巴瘤",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time
Case_IPT<-filter(IPT,  grepl("淋巴瘤",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time
Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)
Case_all<-rbind(Case_OPT,Case_IPT)
Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_pre$CCI_lymphoma<-2
summary_Case_pre<-summary_Case_pre %>% select(idcard,  CCI_lymphoma, )
id_list3 <- left_join(id_list2, summary_Case_pre, by = "idcard") 

Case_OPT<-filter(OPT,  grepl("艾滋病",disease_name) | grepl("人类免疫缺陷病毒",disease_name))
Case_OPT$Case_time<-Case_OPT$clinic_time
Case_IPT<-filter(IPT,  grepl("艾滋病",disease_name) | grepl("人类免疫缺陷病毒",disease_name))
Case_IPT$Case_time<-Case_IPT$dis_time
Case_OPT <- Case_OPT %>% select(idcard, dt_name, Case_time)
Case_IPT <- Case_IPT %>% select(idcard, dt_name, Case_time)
Case_all<-rbind(Case_OPT,Case_IPT)
Case_all_index <- inner_join(Case_all,id_list_index, by = "idcard") 
Case_pre_index<-Case_all_index [Case_all_index$Dx_date-365<=Case_all_index$Case_time & Case_all_index$Case_time<Case_all_index$Dx_date,]
summary_Case_pre<-Case_pre_index %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Case_time), min, na.rm = TRUE)
summary_Case_pre$CCI_hiv<-6
summary_Case_pre<-summary_Case_pre %>% select(idcard,  CCI_hiv, )
id_list4 <- left_join(id_list3, summary_Case_pre, by = "idcard") 

id_list4$Age_cal<-year(id_list4$Dx_date)-year(id_list4$Dob)
id_list4$Age_cat[id_list4$Age_cal<=40]<-0
id_list4$Age_cat[id_list4$Age_cal> 40 & id_list4$Age_cal<=50]<-1
id_list4$Age_cat[id_list4$Age_cal> 50 & id_list4$Age_cal<=60]<-2
id_list4$Age_cat[id_list4$Age_cal> 60 & id_list4$Age_cal<=70]<-3
id_list4$Age_cat[id_list4$Age_cal> 70 ]<-4

id_list4$CCI_liver[!is.na(id_list4$Ascites_pre_dx_date) |
                  !is.na(id_list4$Hepaence_pre_dx_date) |
                    !is.na(id_list4$Cirrhosis_pre_dx_date) |
                    !is.na(id_list4$Fattyliver_pre_dx_date) |
                    !is.na(id_list4$HBV_pre_dx_date) |
                    !is.na(id_list4$HCV_pre_dx_date) |
                    !is.na(id_list4$AutoHepatitis_pre_dx_date) |
                    !is.na(id_list4$DILI_pre_date) ]<-1
id_list4$CCI_livercomplic[!is.na(id_list4$Ascites_pre_dx_date) |
                     !is.na(id_list4$Hepaence_pre_dx_date) |
                     !is.na(id_list4$Cirrhosis_pre_dx_date) ]<-2

id_list4$CCI_MI[is.na(id_list4$CCI_MI)] <- 0
id_list4$CCI_CHF[is.na(id_list4$CCI_CHF)] <- 0
id_list4$CCI_CVD[is.na(id_list4$CCI_CVD)] <- 0
id_list4$CCI_PVD[is.na(id_list4$CCI_PVD)] <- 0
id_list4$CCI_Hemiplegia[is.na(id_list4$CCI_Hemiplegia)] <- 0
id_list4$CCI_Dementia[is.na(id_list4$CCI_Dementia)] <- 0
id_list4$CCI_COPD[is.na(id_list4$CCI_COPD)] <- 0
id_list4$CCI_CTD[is.na(id_list4$CCI_CTD)] <- 0
id_list4$CCI_PUD[is.na(id_list4$CCI_PUD)] <- 0
id_list4$CCI_Diabetes[is.na(id_list4$CCI_Diabetes)] <- 0
id_list4$CCI_Diabetescomplic[is.na(id_list4$CCI_Diabetescomplic)] <- 0
id_list4$CCI_CKD[is.na(id_list4$CCI_CKD)] <- 0
id_list4$CCI_cancer[is.na(id_list4$CCI_cancer)] <- 0
id_list4$CCI_cancermeta[is.na(id_list4$CCI_cancermeta)] <- 0
id_list4$CCI_leukemia[is.na(id_list4$CCI_leukemia)] <- 0
id_list4$CCI_lymphoma[is.na(id_list4$CCI_lymphoma)] <- 0
id_list4$CCI_hiv[is.na(id_list4$CCI_hiv)] <- 0
id_list4$CCI_liver[is.na(id_list4$CCI_liver)] <- 0
id_list4$CCI_livercomplic[is.na(id_list4$CCI_livercomplic)] <- 0

id_list4$CCI_score<-id_list4$CCI_MI+id_list4$CCI_CHF+id_list4$CCI_CVD+id_list4$CCI_PVD+
  id_list4$CCI_Hemiplegia+id_list4$CCI_Dementia+id_list4$CCI_COPD+id_list4$CCI_CTD+
  id_list4$CCI_PUD+id_list4$CCI_Diabetes+id_list4$CCI_Diabetescomplic+id_list4$CCI_CKD+
  id_list4$CCI_cancer+id_list4$CCI_cancermeta+id_list4$CCI_leukemia+id_list4$CCI_lymphoma+
  id_list4$CCI_hiv+id_list4$CCI_liver+id_list4$CCI_livercomplic+id_list4$Age_cat

id_list4$CCI_cat<-if_else(id_list4$CCI_score<=4,id_list4$CCI_score,4)
table(id_list4$CCI_cat)

#Estimating baseline lab values for liver function
Lab1<-read_csv("Lab1.csv")
Lab2<-read_csv("Lab2.csv")

Lab1 <- inner_join(Lab1,id_list_index,  by = "idcard") 
Lab1 <- Lab1[Lab1$report_time<Lab1$Dx_date & Lab1$report_time>=Lab1$Dx_date-365,]

Lab2 <- inner_join(Lab2,id_list_index,  by = "idcard") 
Lab2 <- Lab2[Lab2$report_time<Lab2$Dx_date & Lab2$report_time>=Lab2$Dx_date-365,]

Lab1_ALT<-Lab1[(Lab1$assay_item_name=="丙氨酸氨基转移酶(ALT)" |
                  Lab1$assay_item_name=="丙氨酸氨基转氨酶" |
                  Lab1$assay_item_name=="丙氨酸氨基转移酶(ALT)" |
                  Lab1$assay_item_name=="谷丙氨酸转移酶" |
                  Lab1$assay_item_name=="丙氨酸转氨酶(ALT)" |
                  Lab1$assay_item_name=="丙氨酸转氨酶" |
                  Lab1$assay_item_name=="丙氨酸氨基转氨酶(急)" |
                  Lab1$assay_item_name=="血清丙氨酸氨基转移酶" |
                  Lab1$assay_item_name=="丙氨酸氨基转移酶(ALT)*" |
                  Lab1$assay_item_name=="丙氨酸转移酶" |
                  Lab1$assay_item_name=="血清丙氨酸氨基转移酶测定(免)" |
                  Lab1$assay_item_name=="丙氨酸氨基转移酶（急）" |
                  Lab1$assay_item_name=="丙氨酸氨基转移酶测定" |
                  Lab1$assay_item_name=="血清丙氨酸氨基转移酶测定" |
                  Lab1$assay_item_name=="谷氨酸氨基转移酶" |
                  Lab1$assay_item_name=="谷氨酸基转移酶" |
                  Lab1$assay_item_name=="谷丙转氨酶" |
                  Lab1$assay_item_name=="谷丙转氨酶(急)" |
                  Lab1$assay_item_name=="谷丙氨酸转移酶" |
                  Lab1$assay_item_name=="谷丙转氨酶(ALT)" |
                  Lab1$assay_item_name=="谷丙转氨酶(速率法)" |
                  Lab1$assay_item_name=="血清谷丙转氨酶" |
                  Lab1$assay_item_name=="谷丙转氨酶（免费）" |
                  Lab1$assay_item_name=="谷丙转氨酶（免）" |
                  Lab1$assay_item_name=="谷丙酸氨基转移酶"),]

Lab1_ALT$refrange_hi[grepl("35", Lab1_ALT$refrange, fixed = TRUE)]<-35
Lab1_ALT$refrange_hi[grepl("40", Lab1_ALT$refrange, fixed = TRUE)]<-40
Lab1_ALT$refrange_hi[grepl("44", Lab1_ALT$refrange, fixed = TRUE)]<-44
Lab1_ALT$refrange_hi[grepl("45", Lab1_ALT$refrange, fixed = TRUE)]<-45
Lab1_ALT$refrange_hi[grepl("49", Lab1_ALT$refrange, fixed = TRUE)]<-49
Lab1_ALT$refrange_hi[grepl("50", Lab1_ALT$refrange, fixed = TRUE)]<-50
Lab1_ALT$refrange_hi[grepl("52", Lab1_ALT$refrange, fixed = TRUE)]<-52
Lab1_ALT$refrange_hi[grepl("54", Lab1_ALT$refrange, fixed = TRUE)]<-54
Lab1_ALT$refrange_hi[grepl("55", Lab1_ALT$refrange, fixed = TRUE)]<-55
Lab1_ALT$refrange_hi[grepl("60", Lab1_ALT$refrange, fixed = TRUE)]<-60
Lab1_ALT$refrange_hi[grepl("65", Lab1_ALT$refrange, fixed = TRUE)]<-65
Lab1_ALT$refrange_hi[grepl("72", Lab1_ALT$refrange, fixed = TRUE)]<-72

Lab1_ALT$result<-as.numeric(Lab1_ALT$result)

Lab1_ALT_valid<-Lab1_ALT[!is.na(Lab1_ALT$refrange_hi),]
Lab1_ALT_valid<-Lab1_ALT_valid[!is.na(Lab1_ALT_valid$result),]
Lab1_ALT_valid<-Lab1_ALT_valid[!is.na(Lab1_ALT_valid$refrange_hi),]

Lab2_ALT<-Lab2[Lab2$assay_item_name=="丙氨酸氨基转移酶(ALT)" |
                 Lab2$assay_item_name=="丙氨酸氨基转氨酶" |
                 Lab2$assay_item_name=="丙氨酸氨基转移酶(ALT)" |
                 Lab2$assay_item_name=="谷丙氨酸转移酶" |
                 Lab2$assay_item_name=="丙氨酸转氨酶(ALT)" |
                 Lab2$assay_item_name=="丙氨酸转氨酶" |
                 Lab2$assay_item_name=="丙氨酸氨基转氨酶(急)" |
                 Lab2$assay_item_name=="血清丙氨酸氨基转移酶" |
                 Lab2$assay_item_name=="丙氨酸氨基转移酶(ALT)*" |
                 Lab2$assay_item_name=="丙氨酸转移酶" |
                 Lab2$assay_item_name=="血清丙氨酸氨基转移酶测定(免)" |
                 Lab2$assay_item_name=="丙氨酸氨基转移酶（急）" |
                 Lab2$assay_item_name=="丙氨酸氨基转移酶测定" |
                 Lab2$assay_item_name=="血清丙氨酸氨基转移酶测定" |
                 Lab2$assay_item_name=="谷氨酸氨基转移酶" |
                 Lab2$assay_item_name=="谷氨酸基转移酶" |
                 Lab2$assay_item_name=="谷丙转氨酶" |
                 Lab2$assay_item_name=="谷丙转氨酶(急)" |
                 Lab2$assay_item_name=="谷丙氨酸转移酶" |
                 Lab2$assay_item_name=="谷丙转氨酶(ALT)" |
                 Lab2$assay_item_name=="谷丙转氨酶(速率法)" |
                 Lab2$assay_item_name=="血清谷丙转氨酶" |
                 Lab2$assay_item_name=="谷丙转氨酶（免费）" |
                 Lab2$assay_item_name=="谷丙转氨酶（免）" |
                 Lab2$assay_item_name=="谷丙酸氨基转移酶",]

Lab2_ALT$refrange_hi[grepl("35", Lab2_ALT$refrange, fixed = TRUE)]<-35
Lab2_ALT$refrange_hi[grepl("40", Lab2_ALT$refrange, fixed = TRUE)]<-40
Lab2_ALT$refrange_hi[grepl("44", Lab2_ALT$refrange, fixed = TRUE)]<-44
Lab2_ALT$refrange_hi[grepl("45", Lab2_ALT$refrange, fixed = TRUE)]<-45
Lab2_ALT$refrange_hi[grepl("49", Lab2_ALT$refrange, fixed = TRUE)]<-49
Lab2_ALT$refrange_hi[grepl("50", Lab2_ALT$refrange, fixed = TRUE)]<-50
Lab2_ALT$refrange_hi[grepl("52", Lab2_ALT$refrange, fixed = TRUE)]<-52
Lab2_ALT$refrange_hi[grepl("54", Lab2_ALT$refrange, fixed = TRUE)]<-54
Lab2_ALT$refrange_hi[grepl("55", Lab2_ALT$refrange, fixed = TRUE)]<-55
Lab2_ALT$refrange_hi[grepl("60", Lab2_ALT$refrange, fixed = TRUE)]<-60
Lab2_ALT$refrange_hi[grepl("65", Lab2_ALT$refrange, fixed = TRUE)]<-65
Lab2_ALT$refrange_hi[grepl("72", Lab2_ALT$refrange, fixed = TRUE)]<-72

Lab2_ALT$result<-as.numeric(Lab2_ALT$result)

Lab2_ALT_valid<-Lab2_ALT[!is.na(Lab2_ALT$refrange_hi),]
Lab2_ALT_valid<-Lab2_ALT_valid[!is.na(Lab2_ALT_valid$result),]
Lab2_ALT_valid<-Lab2_ALT_valid[!is.na(Lab2_ALT_valid$refrange_hi),]

Lab_ALT_valid <- rbind(Lab1_ALT_valid,Lab2_ALT_valid)


Lab_ALT_abn<-Lab_ALT_valid[Lab_ALT_valid$result>Lab_ALT_valid$refrange_hi,]
ALT_id_abn<-Lab_ALT_abn %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(report_time), min, na.rm = TRUE)

#Find the maximum ALT value and dates
ALT_max_id<-Lab_ALT_valid %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(result), max, na.rm = TRUE)
ALT_max <- inner_join(Lab_ALT_valid,  ALT_max_id,  by = "idcard") 
ALT_max <-ALT_max[ALT_max$result.x==ALT_max$result.y,]
ALT_id_max_date<-ALT_max %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(report_time), min, na.rm = TRUE)

ALT_max$ALT_max_ratio<-ALT_max$result.x/ALT_max$refrange_hi
ALT_id_max_ratio<-ALT_max %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(ALT_max_ratio), max, na.rm = TRUE)

colnames(ALT_max_id)[colnames(ALT_max_id) %in% c("result")] <- c("ALT_max_baseline")
colnames(ALT_id_max_date)[colnames(ALT_id_max_date) %in% c("report_time")] <- c("ALT_max_baseline_date")
colnames(ALT_id_max_ratio)[colnames(ALT_id_max_ratio) %in% c("ALT_max_ratio")] <- c("ALT_max_ratio_baseline")
colnames(ALT_id_abn)[colnames(ALT_id_abn) %in% c("report_time")] <- c("ALT_abn_pre_date")

#ALP assessment from Lab1

Lab1_ALP<-Lab1[Lab1$assay_item_name=="碱性磷酸酶" |
                 Lab1$assay_item_name=="碱性磷酸酶(ALP)" |
                 Lab1$assay_item_name=="碱性磷酸酶(ALP)*" |
                 Lab1$assay_item_name=="碱性磷酸酶(速率法)" |
                 Lab1$assay_item_name=="血清碱性磷酸酶测定(免)" |
                 Lab1$assay_item_name=="碱性磷酸酶（免费）" |
                 Lab1$assay_item_name=="碱性磷酸酶（免）" |
                 Lab1$assay_item_name=="血清碱性磷酸酶" ,]

Lab1_ALP$refrange_hi[grepl("125", Lab1_ALP$refrange, fixed = TRUE)]<-125
Lab1_ALP$refrange_hi[grepl("100", Lab1_ALP$refrange, fixed = TRUE)]<-100
Lab1_ALP$refrange_hi[grepl("135", Lab1_ALP$refrange, fixed = TRUE)]<-135
Lab1_ALP$refrange_hi[grepl("150", Lab1_ALP$refrange, fixed = TRUE)]<-150
Lab1_ALP$refrange_hi[grepl("112", Lab1_ALP$refrange, fixed = TRUE)]<-112
Lab1_ALP$refrange_hi[grepl("140", Lab1_ALP$refrange, fixed = TRUE)]<-140
Lab1_ALP$refrange_hi[grepl("126", Lab1_ALP$refrange, fixed = TRUE)]<-126
Lab1_ALP$refrange_hi[grepl("129", Lab1_ALP$refrange, fixed = TRUE)]<-129
Lab1_ALP$refrange_hi[grepl("120", Lab1_ALP$refrange, fixed = TRUE)]<-120
Lab1_ALP$refrange_hi[grepl("130", Lab1_ALP$refrange, fixed = TRUE)]<-130
Lab1_ALP$refrange_hi[grepl("128", Lab1_ALP$refrange, fixed = TRUE)]<-128
Lab1_ALP$refrange_hi[grepl("136", Lab1_ALP$refrange, fixed = TRUE)]<-136
Lab1_ALP$refrange_hi[grepl("141", Lab1_ALP$refrange, fixed = TRUE)]<-141
Lab1_ALP$refrange_hi[grepl("136", Lab1_ALP$refrange, fixed = TRUE)]<-136
Lab1_ALP$refrange_hi[grepl("172", Lab1_ALP$refrange, fixed = TRUE)]<-172
Lab1_ALP$refrange_hi[grepl("119", Lab1_ALP$refrange, fixed = TRUE)]<-119
Lab1_ALP$refrange_hi[grepl("250", Lab1_ALP$refrange, fixed = TRUE)]<-250
Lab1_ALP$refrange_hi[grepl("450", Lab1_ALP$refrange, fixed = TRUE)]<-450
Lab1_ALP$refrange_hi[grepl("180", Lab1_ALP$refrange, fixed = TRUE)]<-180
Lab1_ALP$refrange_hi[grepl("170", Lab1_ALP$refrange, fixed = TRUE)]<-170
Lab1_ALP$refrange_hi[grepl("500", Lab1_ALP$refrange, fixed = TRUE)]<-500
Lab1_ALP$refrange_hi[grepl("142", Lab1_ALP$refrange, fixed = TRUE)]<-142
Lab1_ALP$refrange_hi[grepl("750", Lab1_ALP$refrange, fixed = TRUE)]<-750
Lab1_ALP$refrange_hi[grepl("90", Lab1_ALP$refrange, fixed = TRUE)]<-90
Lab1_ALP$refrange_hi[grepl("98", Lab1_ALP$refrange, fixed = TRUE)]<-98
Lab1_ALP$refrange_hi[grepl("135", Lab1_ALP$refrange, fixed = TRUE)]<-135
Lab1_ALP$refrange_hi[grepl("162", Lab1_ALP$refrange, fixed = TRUE)]<-162
Lab1_ALP$refrange_hi[grepl("320", Lab1_ALP$refrange, fixed = TRUE)]<-320

Lab1_ALP$result<-as.numeric(Lab1_ALP$result)

Lab1_ALP_valid<-Lab1_ALP[!is.na(Lab1_ALP$refrange_hi),]
Lab1_ALP_valid<-Lab1_ALP_valid[!is.na(Lab1_ALP_valid$result),]
Lab1_ALP_valid<-Lab1_ALP_valid[!is.na(Lab1_ALP_valid$refrange_hi),]

#ALP assessment from Lab2

Lab2_ALP<-Lab2[Lab2$assay_item_name=="碱性磷酸酶" |
                 Lab2$assay_item_name=="碱性磷酸酶(ALP)" |
                 Lab2$assay_item_name=="碱性磷酸酶(ALP)*" |
                 Lab2$assay_item_name=="碱性磷酸酶(速率法)" |
                 Lab2$assay_item_name=="血清碱性磷酸酶测定(免)" |
                 Lab2$assay_item_name=="碱性磷酸酶（免费）" |
                 Lab2$assay_item_name=="碱性磷酸酶（免）" |
                 Lab2$assay_item_name=="血清碱性磷酸酶" ,]

Lab2_ALP$refrange_hi[grepl("125", Lab2_ALP$refrange, fixed = TRUE)]<-125
Lab2_ALP$refrange_hi[grepl("100", Lab2_ALP$refrange, fixed = TRUE)]<-100
Lab2_ALP$refrange_hi[grepl("135", Lab2_ALP$refrange, fixed = TRUE)]<-135
Lab2_ALP$refrange_hi[grepl("150", Lab2_ALP$refrange, fixed = TRUE)]<-150
Lab2_ALP$refrange_hi[grepl("112", Lab2_ALP$refrange, fixed = TRUE)]<-112
Lab2_ALP$refrange_hi[grepl("140", Lab2_ALP$refrange, fixed = TRUE)]<-140
Lab2_ALP$refrange_hi[grepl("126", Lab2_ALP$refrange, fixed = TRUE)]<-126
Lab2_ALP$refrange_hi[grepl("129", Lab2_ALP$refrange, fixed = TRUE)]<-129
Lab2_ALP$refrange_hi[grepl("120", Lab2_ALP$refrange, fixed = TRUE)]<-120
Lab2_ALP$refrange_hi[grepl("130", Lab2_ALP$refrange, fixed = TRUE)]<-130
Lab2_ALP$refrange_hi[grepl("128", Lab2_ALP$refrange, fixed = TRUE)]<-128
Lab2_ALP$refrange_hi[grepl("136", Lab2_ALP$refrange, fixed = TRUE)]<-136
Lab2_ALP$refrange_hi[grepl("141", Lab2_ALP$refrange, fixed = TRUE)]<-141
Lab2_ALP$refrange_hi[grepl("136", Lab2_ALP$refrange, fixed = TRUE)]<-136
Lab2_ALP$refrange_hi[grepl("172", Lab2_ALP$refrange, fixed = TRUE)]<-172
Lab2_ALP$refrange_hi[grepl("119", Lab2_ALP$refrange, fixed = TRUE)]<-119
Lab2_ALP$refrange_hi[grepl("250", Lab2_ALP$refrange, fixed = TRUE)]<-250
Lab2_ALP$refrange_hi[grepl("450", Lab2_ALP$refrange, fixed = TRUE)]<-450
Lab2_ALP$refrange_hi[grepl("180", Lab2_ALP$refrange, fixed = TRUE)]<-180
Lab2_ALP$refrange_hi[grepl("170", Lab2_ALP$refrange, fixed = TRUE)]<-170
Lab2_ALP$refrange_hi[grepl("500", Lab2_ALP$refrange, fixed = TRUE)]<-500
Lab2_ALP$refrange_hi[grepl("142", Lab2_ALP$refrange, fixed = TRUE)]<-142
Lab2_ALP$refrange_hi[grepl("750", Lab2_ALP$refrange, fixed = TRUE)]<-750
Lab2_ALP$refrange_hi[grepl("90", Lab2_ALP$refrange, fixed = TRUE)]<-90
Lab2_ALP$refrange_hi[grepl("98", Lab2_ALP$refrange, fixed = TRUE)]<-98
Lab2_ALP$refrange_hi[grepl("135", Lab2_ALP$refrange, fixed = TRUE)]<-135
Lab2_ALP$refrange_hi[grepl("162", Lab2_ALP$refrange, fixed = TRUE)]<-162
Lab2_ALP$refrange_hi[grepl("320", Lab2_ALP$refrange, fixed = TRUE)]<-320

Lab2_ALP$result<-as.numeric(Lab2_ALP$result)

Lab2_ALP_valid<-Lab2_ALP[!is.na(Lab2_ALP$refrange_hi),]
Lab2_ALP_valid<-Lab2_ALP_valid[!is.na(Lab2_ALP_valid$result),]
Lab2_ALP_valid<-Lab2_ALP_valid[!is.na(Lab2_ALP_valid$refrange_hi),]


Lab_ALP_valid <- rbind(Lab1_ALP_valid,Lab2_ALP_valid)


Lab_ALP_abn<-Lab_ALP_valid[Lab_ALP_valid$result>Lab_ALP_valid$refrange_hi,]
ALP_id_abn<-Lab_ALP_abn %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(report_time), min, na.rm = TRUE)

#Find the maximum ALP value and dates
ALP_max_id<-Lab_ALP_valid %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(result), max, na.rm = TRUE)
ALP_max <- inner_join(Lab_ALP_valid,  ALP_max_id,  by = "idcard") 
ALP_max <-ALP_max[ALP_max$result.x==ALP_max$result.y,]
ALP_id_max_date<-ALP_max %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(report_time), min, na.rm = TRUE)

ALP_max$ALP_max_ratio<-ALP_max$result.x/ALP_max$refrange_hi
ALP_id_max_ratio<-ALP_max %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(ALP_max_ratio), max, na.rm = TRUE)

colnames(ALP_max_id)[colnames(ALP_max_id) %in% c("result")] <- c("ALP_max_baseline")
colnames(ALP_id_max_date)[colnames(ALP_id_max_date) %in% c("report_time")] <- c("ALP_max_baseline_date")
colnames(ALP_id_max_ratio)[colnames(ALP_id_max_ratio) %in% c("ALP_max_ratio")] <- c("ALP_max_ratio_baseline")
colnames(ALP_id_abn)[colnames(ALP_id_abn) %in% c("report_time")] <- c("ALP_abn_pre_date")

#Tbil assessment
Lab1_Tbil<-filter(Lab1, grepl("总胆红素",assay_item_name))

Lab1_Tbil$refrange_hi[grepl("23", Lab1_Tbil$refrange, fixed = TRUE)]<-23
Lab1_Tbil$refrange_hi[grepl("24", Lab1_Tbil$refrange, fixed = TRUE)]<-24
Lab1_Tbil$refrange_hi[grepl("20.3", Lab1_Tbil$refrange, fixed = TRUE)]<-20.3
Lab1_Tbil$refrange_hi[grepl("19.0", Lab1_Tbil$refrange, fixed = TRUE)]<-19
Lab1_Tbil$refrange_hi[grepl("17.1", Lab1_Tbil$refrange, fixed = TRUE)]<-17.1
Lab1_Tbil$refrange_hi[grepl("26.1", Lab1_Tbil$refrange, fixed = TRUE)]<-26.1
Lab1_Tbil$refrange_hi[grepl("19.1", Lab1_Tbil$refrange, fixed = TRUE)]<-19.1
Lab1_Tbil$refrange_hi[grepl("22.0", Lab1_Tbil$refrange, fixed = TRUE)]<-22
Lab1_Tbil$refrange_hi[grepl("20.5", Lab1_Tbil$refrange, fixed = TRUE)]<-20.5
Lab1_Tbil$refrange_hi[grepl("25.0", Lab1_Tbil$refrange, fixed = TRUE)]<-25
Lab1_Tbil$refrange_hi[grepl("26.0", Lab1_Tbil$refrange, fixed = TRUE)]<-26
Lab1_Tbil$refrange_hi[grepl("22.0", Lab1_Tbil$refrange, fixed = TRUE)]<-22
Lab1_Tbil$refrange_hi[grepl("22", Lab1_Tbil$refrange, fixed = TRUE)]<-22
Lab1_Tbil$refrange_hi[grepl("21.0", Lab1_Tbil$refrange, fixed = TRUE)]<-21
Lab1_Tbil$refrange_hi[grepl("25", Lab1_Tbil$refrange, fixed = TRUE)]<-25
Lab1_Tbil$refrange_hi[grepl("22.5", Lab1_Tbil$refrange, fixed = TRUE)]<-22.5
Lab1_Tbil$refrange_hi[grepl("23.5", Lab1_Tbil$refrange, fixed = TRUE)]<-23.5
Lab1_Tbil$refrange_hi[grepl("26", Lab1_Tbil$refrange, fixed = TRUE)]<-26
Lab1_Tbil$refrange_hi[grepl("21.9", Lab1_Tbil$refrange, fixed = TRUE)]<-21.9
Lab1_Tbil$refrange_hi[grepl("20", Lab1_Tbil$refrange, fixed = TRUE)]<-20
Lab1_Tbil$refrange_hi[grepl("51", Lab1_Tbil$refrange, fixed = TRUE)]<-51
Lab1_Tbil$refrange_hi[grepl("19", Lab1_Tbil$refrange, fixed = TRUE)]<-19
Lab1_Tbil$refrange_hi[grepl("21", Lab1_Tbil$refrange, fixed = TRUE)]<-21
Lab1_Tbil$refrange_hi[grepl("18.6", Lab1_Tbil$refrange, fixed = TRUE)]<-18.6
Lab1_Tbil$refrange_hi[grepl("17", Lab1_Tbil$refrange, fixed = TRUE)]<-17

Lab1_Tbil$result<-as.numeric(Lab1_Tbil$result)

Lab1_Tbil_valid<-Lab1_Tbil[!is.na(Lab1_Tbil$refrange_hi),]
Lab1_Tbil_valid<-Lab1_Tbil_valid[!is.na(Lab1_Tbil_valid$result),]
Lab1_Tbil_valid<-Lab1_Tbil_valid[!is.na(Lab1_Tbil_valid$refrange_hi),]

#Tbil assessment in Lab2 files
Lab2_Tbil<-filter(Lab2, grepl("总胆红素",assay_item_name))

Lab2_Tbil$refrange_hi[grepl("23", Lab2_Tbil$refrange, fixed = TRUE)]<-23
Lab2_Tbil$refrange_hi[grepl("24", Lab2_Tbil$refrange, fixed = TRUE)]<-24
Lab2_Tbil$refrange_hi[grepl("20.3", Lab2_Tbil$refrange, fixed = TRUE)]<-20.3
Lab2_Tbil$refrange_hi[grepl("19.0", Lab2_Tbil$refrange, fixed = TRUE)]<-19
Lab2_Tbil$refrange_hi[grepl("17.1", Lab2_Tbil$refrange, fixed = TRUE)]<-17.1
Lab2_Tbil$refrange_hi[grepl("26.1", Lab2_Tbil$refrange, fixed = TRUE)]<-26.1
Lab2_Tbil$refrange_hi[grepl("19.1", Lab2_Tbil$refrange, fixed = TRUE)]<-19.1
Lab2_Tbil$refrange_hi[grepl("22.0", Lab2_Tbil$refrange, fixed = TRUE)]<-22
Lab2_Tbil$refrange_hi[grepl("20.5", Lab2_Tbil$refrange, fixed = TRUE)]<-20.5
Lab2_Tbil$refrange_hi[grepl("25.0", Lab2_Tbil$refrange, fixed = TRUE)]<-25
Lab2_Tbil$refrange_hi[grepl("26.0", Lab2_Tbil$refrange, fixed = TRUE)]<-26
Lab2_Tbil$refrange_hi[grepl("22.0", Lab2_Tbil$refrange, fixed = TRUE)]<-22
Lab2_Tbil$refrange_hi[grepl("22", Lab2_Tbil$refrange, fixed = TRUE)]<-22
Lab2_Tbil$refrange_hi[grepl("21.0", Lab2_Tbil$refrange, fixed = TRUE)]<-21
Lab2_Tbil$refrange_hi[grepl("25", Lab2_Tbil$refrange, fixed = TRUE)]<-25
Lab2_Tbil$refrange_hi[grepl("22.5", Lab2_Tbil$refrange, fixed = TRUE)]<-22.5
Lab2_Tbil$refrange_hi[grepl("23.5", Lab2_Tbil$refrange, fixed = TRUE)]<-23.5
Lab2_Tbil$refrange_hi[grepl("26", Lab2_Tbil$refrange, fixed = TRUE)]<-26
Lab2_Tbil$refrange_hi[grepl("21.9", Lab2_Tbil$refrange, fixed = TRUE)]<-21.9
Lab2_Tbil$refrange_hi[grepl("20", Lab2_Tbil$refrange, fixed = TRUE)]<-20
Lab2_Tbil$refrange_hi[grepl("51", Lab2_Tbil$refrange, fixed = TRUE)]<-51
Lab2_Tbil$refrange_hi[grepl("19", Lab2_Tbil$refrange, fixed = TRUE)]<-19
Lab2_Tbil$refrange_hi[grepl("21", Lab2_Tbil$refrange, fixed = TRUE)]<-21
Lab2_Tbil$refrange_hi[grepl("18.6", Lab2_Tbil$refrange, fixed = TRUE)]<-18.6
Lab2_Tbil$refrange_hi[grepl("17", Lab2_Tbil$refrange, fixed = TRUE)]<-17

Lab2_Tbil$result<-as.numeric(Lab2_Tbil$result)

Lab2_Tbil_valid<-Lab2_Tbil[!is.na(Lab2_Tbil$refrange_hi),]
Lab2_Tbil_valid<-Lab2_Tbil_valid[!is.na(Lab2_Tbil_valid$result),]
Lab2_Tbil_valid<-Lab2_Tbil_valid[!is.na(Lab2_Tbil_valid$refrange_hi),]

Lab_Tbil_valid <- rbind(Lab1_Tbil_valid,Lab2_Tbil_valid)


Lab_Tbil_abn<-Lab_Tbil_valid[Lab_Tbil_valid$result>Lab_Tbil_valid$refrange_hi,]
Tbil_id_abn<-Lab_Tbil_abn %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(report_time), min, na.rm = TRUE)

#Find the maximum Tbil value and dates
Tbil_max_id<-Lab_Tbil_valid %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(result), max, na.rm = TRUE)
Tbil_max <- inner_join(Lab_Tbil_valid,  Tbil_max_id,  by = "idcard") 
Tbil_max <-Tbil_max[Tbil_max$result.x==Tbil_max$result.y,]
Tbil_id_max_date<-Tbil_max %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(report_time), min, na.rm = TRUE)

Tbil_max$Tbil_max_ratio<-Tbil_max$result.x/Tbil_max$refrange_hi
Tbil_id_max_ratio<-Tbil_max %>% 
  group_by(idcard)  %>% 
  summarise_at(vars(Tbil_max_ratio), max, na.rm = TRUE)

colnames(Tbil_max_id)[colnames(Tbil_max_id) %in% c("result")] <- c("Tbil_max_baseline")
colnames(Tbil_id_max_date)[colnames(Tbil_id_max_date) %in% c("report_time")] <- c("Tbil_max_baseline_date")
colnames(Tbil_id_max_ratio)[colnames(Tbil_id_max_ratio) %in% c("Tbil_max_ratio")] <- c("Tbil_max_ratio_baseline")
colnames(Tbil_id_abn)[colnames(Tbil_id_abn) %in% c("report_time")] <- c("Tbil_abn_pre_date")

#Now merge with baseline ALT ALP and Tbil values to analytical cohort
id_list4 <- left_join(id_list4, ALT_max_id, by = "idcard") 
id_list4 <- left_join(id_list4, ALT_id_max_date, by = "idcard") 
id_list4 <- left_join(id_list4, ALT_id_max_ratio, by = "idcard") 
id_list4 <- left_join(id_list4, ALT_id_abn, by = "idcard") 

id_list4 <- left_join(id_list4, ALP_max_id, by = "idcard") 
id_list4 <- left_join(id_list4, ALP_id_max_date, by = "idcard") 
id_list4 <- left_join(id_list4, ALP_id_max_ratio, by = "idcard") 
id_list4 <- left_join(id_list4, ALP_id_abn, by = "idcard") 

id_list4 <- left_join(id_list4, Tbil_max_id, by = "idcard") 
id_list4 <- left_join(id_list4, Tbil_id_max_date, by = "idcard") 
id_list4 <- left_join(id_list4, Tbil_id_max_ratio, by = "idcard") 
id_list4 <- left_join(id_list4, Tbil_id_abn, by = "idcard") 

id_list4$ALT_abn_pre<-if_else(is.na(id_list4$ALT_abn_pre_date),0,1)
id_list4$ALP_abn_pre<-if_else(is.na(id_list4$ALP_abn_pre_date),0,1)
id_list4$Tbil_abn_pre<-if_else(is.na(id_list4$Tbil_abn_pre_date),0,1)

#Merge with death cause files
deathreason<-read_xlsx("E:/Ningbo Projects/TB/TB project/Raw data/deathreason20201015.xlsx")

id_list5 <- left_join(id_list4, deathreason, by = "idcard") 
colnames(id_list5)[colnames(id_list5) %in% c("Alt_max_ratio")] <- c("ALT_max_ratio")


#Assign Grade of DILI based on lab findings
id_list5$DILI_grade1[!is.na(id_list5$DILI_post_date) & 
                       (!is.na(id_list5$ALT_max_ratio) | !is.na(id_list5$ALP_max_ratio)| !is.na(id_list5$Tbil_max_ratio)) &
                       ((!is.na(id_list5$ALT_abn_post_date) | !is.na(id_list5$ALP_abn_post_date)) & 
                          (id_list5$Tbil_max_ratio<2.5 | is.na(id_list5$Tbil_max_ratio)) &
                          (id_list5$INR_max_result<1.5 | is.na(id_list5$INR_max_result)))]<-1

id_list5$DILI_grade2[!is.na(id_list5$DILI_post_date) & 
                       (!is.na(id_list5$ALT_max_ratio) | !is.na(id_list5$ALP_max_ratio) |!is.na(id_list5$Tbil_max_ratio)) &
                       ((!is.na(id_list5$ALT_abn_post_date) | !is.na(id_list5$ALP_abn_post_date)) & 
                         ( (id_list5$Tbil_max_ratio>=2.5 & id_list5$Tbil_max_ratio<5 & !is.na(id_list5$Tbil_max_ratio)) |
                          (id_list5$INR_max_result>=1.5 & !is.na(id_list5$INR_max_result))))]<-1

id_list5$DILI_grade3[!is.na(id_list5$DILI_post_date) & 
                       (!is.na(id_list5$ALT_max_ratio) | !is.na(id_list5$ALP_max_ratio) |!is.na(id_list5$Tbil_max_ratio)) &
                       ((!is.na(id_list5$ALT_abn_post_date) | !is.na(id_list5$ALP_abn_post_date)) & 
                          ( (id_list5$Tbil_max_ratio>=5 & !is.na(id_list5$Tbil_max_ratio)) &
                            (id_list5$DILI_post_type=="IPT") &
                            is.na(id_list5$Hepaence_post_dx_date)))]<-1

id_list5$DILI_grade4[!is.na(id_list5$DILI_post_date) & 
                       (!is.na(id_list5$ALT_max_ratio) | !is.na(id_list5$ALP_max_ratio) |!is.na(id_list5$Tbil_max_ratio)) &
                          ( (id_list5$Tbil_max_ratio>=10 & !is.na(id_list5$Tbil_max_ratio)) &
                             ( (!is.na(id_list5$PTA_40_post_date) | (id_list5$INR_max_result>=1.5 & !is.na(id_list5$INR_max_result))) |
                              (!is.na(id_list5$Hepaence_post_dx_date))
                              ))]<-1
id_list5$DILI_grade5[!is.na(id_list5$DILI_post_date) & 
                      ( grepl("肝",id_list5$`(a)直接导致死亡的疾病或情况（手工录入）`) & grepl("衰竭",id_list5$`(a)直接导致死亡的疾病或情况（手工录入）`) |
                       grepl("肝",id_list5$`(a)直接导致死亡的疾病或情况`) & grepl("衰竭",id_list5$`(a)直接导致死亡的疾病或情况`) |
                       grepl("肝",id_list5$根本死亡原因) & grepl("衰竭",id_list5$根本死亡原因) ) |
                       (grepl("药物性肝",id_list5$`(a)直接导致死亡的疾病或情况（手工录入）`) |
                       grepl("药物性肝",id_list5$`(a)直接导致死亡的疾病或情况`) |
                       grepl("药物性肝",id_list5$根本死亡原因))]<-1

id_list5$DILI_final[id_list5$DILI_grade5==1]<-5
id_list5$DILI_final[id_list5$DILI_grade4==1 & is.na(id_list5$DILI_grade5)]<-4
id_list5$DILI_final[id_list5$DILI_grade3==1 & is.na(id_list5$DILI_grade5) & is.na(id_list5$DILI_grade4)]<-3
id_list5$DILI_final[id_list5$DILI_grade2==1 & is.na(id_list5$DILI_grade5) & is.na(id_list5$DILI_grade4) 
                   & is.na(id_list5$DILI_grade3)]<-2
id_list5$DILI_final[id_list5$DILI_grade1==1 & is.na(id_list5$DILI_grade5) & is.na(id_list5$DILI_grade4) 
                   & is.na(id_list5$DILI_grade3) & is.na(id_list5$DILI_grade2)]<-1
id_list5$DILI_final[!is.na(id_list5$DILI_post_date)& is.na(id_list5$DILI_grade5) & is.na(id_list5$DILI_grade4) 
                    & is.na(id_list5$DILI_grade3) & is.na(id_list5$DILI_grade2) & is.na(id_list5$DILI_grade1)]<-99
id_list5$DILI_final[is.na(id_list5$DILI_post_date)]<-0

write_excel_csv(id_list5,"id_list_0115_final.csv")
